import packageJson from '@/../package.json'
import schemas from '@/model/schemas'
import { FastifyCorsOptions, FastifyCorsOptionsDelegate } from '@fastify/cors'
import { FastifyJWTOptions } from '@fastify/jwt'
import { SwaggerOptions } from '@fastify/swagger'
import { FastifySwaggerUiOptions } from '@fastify/swagger-ui'
import {
  FastifyBaseLogger,
  FastifyHttpOptions,
  FastifyRegisterOptions,
} from 'fastify'
import {
  createJsonSchemaTransformObject,
  jsonSchemaTransform,
} from 'fastify-type-provider-zod'
import { IncomingMessage, Server, ServerResponse } from 'node:http'

//==============================================================================
// Constants for API Documentation
//==============================================================================
const LOGO = `<svg width="6709" height="1969" viewBox="0 0 6709 1969" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M6612.4 279.7L6709 29.5L6704.8 14L5749.1 265.8C5851 118.4 5816 0.200001 5816 0.200001C5816 0.200001 5510.8 195.1 5280 190C5049.2 184.9 4974.8 123.3 4620.9 236.2C4267 349 4167 695.3 4064.4 769.7C3961.8 844.1 3639.9 1086.4 3639.9 1086.4L3640.6 1090.7L3930.8 998.3C3930.8 998.3 3851.2 1073.3 3682.1 1301.2C3682.1 1301.2 3679.2 1298.5 3674.2 1293.9L3674.5 1295.5C3674.5 1295.5 3810.4 1503.2 3943.8 1464.8C3957.2 1460.9 3972.3 1454.5 3988.8 1446.1C4042.5 1476 4112.6 1505.4 4190 1513.5C4190 1513.5 4137.6 1452.6 4093.9 1383.3C4105.7 1375.7 4117.8 1367.8 4130.1 1359.8L4124.4 1363.8L4234.9 1404.4L4222.7 1300.5C4223.1 1300.3 4223.4 1300 4223.8 1299.8L4332.4 1339.7L4318.9 1245.2C4332.7 1238 4346.4 1231.2 4360.1 1224.9L4473.3 796.7L4941.4 477.4L4904.2 571C4809.3 804.4 4631.1 859.5 4631.1 859.5L4556.7 887.7C4501.4 953.1 4478.1 969.2 4459.1 1188.7C4503.7 1177.5 4546.3 1174.8 4584.9 1185.2C4784.9 1239.1 4854.2 1480.1 4800.3 1546.8C4786.8 1563.5 4754.7 1592 4714.2 1625.5H4633L4631.9 1691.3C4629.1 1693.5 4626.3 1695.6 4623.6 1697.8H4541L4540 1762C4532.7 1767.6 4525.4 1773 4518.4 1778.3C4440.8 1779.9 4342.5 1712.2 4342.5 1712.2C4342.5 1773.8 4393.8 1868.6 4393.8 1868.6C4393.8 1868.6 4397.2 1867 4402.9 1864.2C4397.9 1867.9 4395.1 1869.9 4395.1 1869.9C4395.1 1869.9 4602.8 2008.4 4733.6 1957.1C4849.9 1911.5 5151 1674.1 5410.9 1561.7L6197.4 1354.5L6301.1 1085.8L5701.7 1243.7V1002.4L6405 817.1L6508.7 548.4L5701.9 761V519.6L6612.4 279.7ZM5185 791.2L5371.6 742L5374.1 751.3L5315.9 902.1L5122.5 953.1L5185 791.2ZM5249.4 1114L5056 1165L5118.5 1003L5305.1 953.8L5307.6 963.1L5249.4 1114ZM5501.4 1059.9L5308 1110.9L5370.5 948.9L5557.1 899.7L5559.6 909L5501.4 1059.9Z" fill="white"/>
<path d="M195.7 604.5L201.8 573.7C218.8 484.4 252.7 407.3 315.8 348.8C362 305.7 429.8 279.5 506.8 279.5C556.1 279.5 593.1 287.2 616.2 294.9L573.1 442.8C554.6 436.6 537.7 433.6 513 433.6C443.7 433.6 403.6 506 391.3 572.2L385.1 604.5H531.5L505.3 740.1H362L243.4 1357.9H50.8L169.4 740.1" fill="white"/>
<path d="M825.8 1357.9C827.3 1317.9 830.4 1276.2 831.9 1231.6H827.3C767.2 1331.8 694.8 1370.3 634.7 1370.3C525.3 1370.3 471.4 1276.3 471.4 1143.8C471.4 915.8 585.4 592.3 908.9 592.3C984.4 592.3 1059.9 604.6 1106.1 623.1L1023 1042C1004.5 1129.8 990.6 1276.2 992.2 1357.8H825.8V1357.9ZM895.1 740.1C879.7 737 865.8 735.5 855.1 735.5C728.8 735.5 661 986.6 659.4 1097.6C659.4 1163.9 668.7 1211.6 716.4 1211.6C768.8 1211.6 818.1 1125.3 845.8 988.2L895.1 740.1Z" fill="white"/>
<path d="M1129.3 1193C1160.1 1210 1197.1 1225.3 1251 1223.8C1306.5 1222.3 1337.3 1186.8 1337.3 1139.1C1337.3 1097.5 1317.3 1068.2 1264.9 1026.6C1200.2 974.2 1169.4 908 1169.4 843.3C1169.4 704.6 1277.2 592.2 1448.3 592.2C1514.6 592.2 1562.3 604.5 1590 619.9L1548.4 760.1C1526.8 747.8 1491.4 737 1459.1 737C1397.5 737 1359 769.3 1359 820.2C1359 858.7 1380.6 881.8 1416 911.1C1500.7 975.8 1528.5 1049.7 1528.5 1108.3C1528.5 1274.7 1412.9 1367.1 1240.4 1367.1C1171.1 1367.1 1109.4 1347.1 1083.2 1328.6L1129.3 1193Z" fill="white"/>
<path d="M1979.7 401.1L1941.2 604.5H2237L2212.3 740.1H1915L1848.7 1089.8C1844.1 1116 1842.5 1139.1 1842.5 1153C1842.5 1199.2 1865.6 1216.2 1901.1 1216.2C1915 1216.2 1935 1216.2 1953.5 1213.1L1930.4 1357.9C1895 1367.2 1851.8 1370.2 1814.8 1370.2C1699.3 1370.2 1642.2 1305.5 1642.2 1203.8C1642.2 1169.9 1648.4 1128.3 1656.1 1091.3L1722.4 740H1634.6L1660.8 604.4H1748.6L1779.4 448.8L1979.7 401.1Z" fill="white"/>
<path d="M2026 1357.9L2170.8 604.5H2363.4L2218.6 1357.9H2026ZM2206.2 411.9C2206.2 356.5 2246.2 293.3 2314 293.3C2377.2 293.3 2406.5 341 2404.9 393.4C2403.4 470.4 2351 513.6 2294 513.6C2232.4 513.6 2204.7 468.9 2206.2 411.9Z" fill="white"/>
<path d="M2483 604.5L2489.1 573.7C2506.1 484.4 2540 407.3 2603.1 348.8C2649.3 305.7 2717.1 279.5 2794.1 279.5C2843.4 279.5 2880.4 287.2 2903.5 294.9L2860.4 442.8C2841.9 436.6 2825 433.6 2800.3 433.6C2731 433.6 2690.9 506 2678.6 572.2L2672.4 604.5H2895.8L2869.6 740.1H2649.3L2530.7 1357.9H2338.1L2456.7 740.1" fill="white"/>
<path d="M3016.1 604.5L3020.7 966.6C3022.2 1037.5 3023.8 1089.9 3022.2 1145.3H3025.3C3040.7 1083.7 3056.1 1032.8 3082.3 952.7L3196.3 604.5H3390.4L3144 1197.6C3070 1370.2 2985.3 1515 2892.9 1599.7C2848.2 1641.3 2795.9 1673.7 2763.5 1687.5L2686.5 1530.3C2720.4 1513.3 2755.8 1493.3 2786.6 1468.7C2829.8 1433.2 2871.3 1390.1 2889.8 1348.5C2892.9 1337.7 2895.9 1330 2894.4 1314.6L2814.3 604.3H3016.1V604.5Z" fill="white"/>
<path d="M12.1712 1798L75.0188 1474.91H180.576C241.211 1474.47 282.593 1491.95 271.528 1549.27C261.349 1601.05 219.745 1621.85 183.453 1626.05L183.01 1628.05C225.499 1629.37 267.545 1650.84 256.48 1707.49C244.752 1767.9 188.543 1798 119.278 1798H12.1712ZM86.5261 1751.53H109.983C152.25 1751.53 183.232 1739.58 190.756 1700.85C198.28 1663.01 172.61 1653.72 129.015 1653.72H105.557L86.5261 1751.53ZM114.188 1609.24H132.555C173.716 1609.24 198.722 1591.97 204.476 1561.44C209.787 1534 193.633 1521.38 154.685 1521.38H131.228L114.188 1609.24ZM488.448 1684.92C472.073 1769.45 414.094 1803.31 353.68 1803.31C285.964 1803.31 237.722 1765.03 254.762 1676.73C271.359 1592.2 329.559 1556.35 389.972 1556.35C457.689 1556.35 505.709 1596.62 488.448 1684.92ZM425.158 1680.71C436.002 1624.51 417.192 1605.25 386.432 1605.25C355.672 1605.25 329.117 1624.51 318.273 1680.71C307.208 1736.92 326.682 1754.18 357.442 1754.18C388.202 1754.18 414.094 1736.92 425.158 1680.71ZM476.55 1798L486.73 1746.22H561.749L587.64 1613.22H512.621L522.58 1561.66L655.135 1555.9L661.11 1562.99L625.481 1746.22H700.279L690.321 1798H476.55ZM627.031 1522.49C602.024 1522.49 588.083 1507.44 592.509 1483.76C597.377 1460.08 617.072 1445.48 642.079 1445.48C667.085 1445.48 681.026 1460.08 676.379 1483.76C671.953 1507.44 652.037 1522.49 627.031 1522.49ZM711.174 1798L721.354 1746.22H796.594L842.402 1510.98H767.383L777.12 1459.42L909.675 1453.67L915.65 1460.75L860.105 1746.22H935.124L924.945 1798H711.174ZM958.854 1675.18C974.788 1592.2 1028.34 1556.35 1096.28 1556.35C1168.2 1556.35 1203.83 1595.96 1189.66 1669.65L1185.9 1688.68H1020.82C1014.62 1731.17 1029 1754.18 1063.08 1754.18C1084.55 1754.18 1103.58 1745.55 1116.64 1725.42L1176.39 1734.05C1149.17 1785.61 1103.14 1803.31 1057.33 1803.31C987.18 1803.31 942.7 1757.5 958.854 1675.18ZM1030.11 1651.5H1131.02V1651.06C1137.22 1620.08 1121.28 1605.25 1092.74 1605.25C1066.18 1605.25 1043.39 1618.31 1030.11 1651.5ZM1334 1561.66L1330.46 1596.84H1338.2C1363.65 1570.29 1387.33 1556.35 1424.51 1556.35C1433.36 1556.35 1440.44 1557.01 1447.08 1559L1435.35 1619.64C1390.65 1619.64 1360.56 1621.85 1327.36 1635.57L1305.9 1746.22H1375.82L1365.65 1798H1179.54L1189.72 1746.22H1242.38L1268.05 1613.44H1215.61L1225.57 1561.66H1334ZM1662.01 1683.15C1648.07 1754.41 1610.67 1803.31 1551.14 1803.31C1516.84 1803.31 1498.7 1787.6 1488.74 1769.45H1485.2L1463.95 1879.22H1400.44L1461.96 1561.66H1517.73L1515.07 1590.43H1523.26C1538.31 1572.28 1563.98 1556.35 1596.51 1556.35C1656.26 1556.35 1675.73 1612.56 1662.01 1683.15ZM1490.95 1739.8C1503.78 1747.54 1518.17 1750.86 1531.89 1750.86C1567.74 1750.86 1588.98 1728.73 1598.5 1679.16C1608.01 1629.82 1592.97 1608.79 1557.12 1608.79C1542.95 1608.79 1528.13 1612.33 1514.41 1619.42L1490.95 1739.8ZM1649.67 1798L1659.85 1746.22H1735.09L1780.9 1510.98H1705.88L1715.62 1459.42L1848.17 1453.67L1854.15 1460.75L1798.6 1746.22H1873.62L1863.44 1798H1649.67ZM2025.48 1556.35C2086.11 1556.35 2123.96 1580.03 2113.33 1634.46L2093.64 1735.6C2090.76 1749.98 2094.52 1753.74 2113.55 1752.41L2104.48 1798C2090.54 1801.32 2077.93 1803.09 2066.42 1803.09C2034.33 1803.09 2026.59 1789.59 2027.69 1770.34H2021.05C2004.46 1789.15 1977.02 1803.31 1947.14 1803.31C1905.54 1803.31 1881.42 1774.76 1889.38 1734.05C1902 1669.43 1974.58 1663.9 2043.85 1665.22L2050.04 1633.14C2054.91 1607.69 2040.75 1599.28 2018.4 1599.06C1995.38 1599.06 1978.12 1608.35 1974.36 1628.27L1972.59 1636.68H1916.16L1918.37 1625.39C1926.34 1584.67 1954.44 1556.35 2025.48 1556.35ZM1956.44 1730.73C1953.34 1747.32 1964.62 1757.95 1985.42 1757.95C2000.03 1757.95 2014.86 1752.86 2028.13 1744.89L2037.21 1698.42C2033 1697.97 2028.58 1697.75 2023.93 1697.75C1983.65 1697.75 1960.64 1709.04 1956.44 1730.73ZM2268.07 1804.64C2195.26 1804.64 2170.7 1785.61 2186.85 1701.52L2204.12 1613.44H2146.36L2156.32 1561.66H2214.07L2226.69 1497.04H2290.2L2277.59 1561.66H2368.76L2358.8 1613.44H2267.63L2250.37 1701.74C2242.84 1741.57 2253.46 1750.2 2287.1 1750.2C2302.81 1750.2 2320.3 1747.54 2338.66 1743.56L2328.26 1797.34C2310.78 1801.76 2290.42 1804.64 2268.07 1804.64ZM2366.6 1675.18C2382.53 1592.2 2436.08 1556.35 2504.02 1556.35C2575.94 1556.35 2611.57 1595.96 2597.41 1669.65L2593.65 1688.68H2428.56C2422.36 1731.17 2436.75 1754.18 2470.83 1754.18C2492.29 1754.18 2511.32 1745.55 2524.38 1725.42L2584.13 1734.05C2556.91 1785.61 2510.88 1803.31 2465.07 1803.31C2394.92 1803.31 2350.44 1757.5 2366.6 1675.18ZM2437.85 1651.5H2538.76V1651.06C2544.96 1620.08 2529.03 1605.25 2500.48 1605.25C2473.93 1605.25 2451.13 1618.31 2437.85 1651.5Z" fill="white"/>
</svg>`
const TITLE = 'Fastify Boilerplate API'
const DESCRIPTION =
  'Modern backend API template using **Fastify**, **Zod**, and **Prisma**, providing integrated data validation and self-documentation using **Zod-type-provider**.'
const VERSION = packageJson.version

//==============================================================================
// JWT Configuration
//==============================================================================

/**
 * Configuration options for Fastify JWT plugin
 * @description Sets up JWT authentication with the provided secret and expiration time
 */
export const fastifyJwtOptions: FastifyRegisterOptions<FastifyJWTOptions> = {
  secret: process.env.JWT_SECRET as string,
  sign: {
    expiresIn: '12h',
  },
}

//==============================================================================
// CORS Configuration
//==============================================================================

/**
 * Configuration options for Fastify CORS plugin
 * @description Defines allowed origins, methods and headers for cross-origin requests
 */
export const fastifyCorsOptions: FastifyRegisterOptions<
  FastifyCorsOptions | FastifyCorsOptionsDelegate
> = {
  origin: '*',
  // Avoid using '*' in production, specify allowed origins instead
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization'],
}

//==============================================================================
// Swagger Documentation Configuration
//==============================================================================

/**
 * Configuration options for Fastify Swagger plugin
 * @description Sets up OpenAPI documentation with JWT authentication
 */
export const fastifySwaggerOptions: FastifyRegisterOptions<SwaggerOptions> = {
  openapi: {
    info: {
      title: TITLE,
      description: DESCRIPTION,
      version: VERSION,
    },
    servers: [],
    components: {
      securitySchemes: {
        BearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description:
            'JWT authentication. You must provide a valid JWT token in the header of your request.',
        },
      },
    },
    security: [
      {
        BearerAuth: [],
      },
    ],
  },
  transform: jsonSchemaTransform,
  transformObject: createJsonSchemaTransformObject({
    schemas,
  }),
}

/**
 * Configuration options for Fastify Swagger UI plugin
 * @description Sets the route prefix for the Swagger UI documentation
 */
export const fastifySwaggerUiOptions: FastifyRegisterOptions<FastifySwaggerUiOptions> =
  {
    logo: {
      type: 'image/svg+xml',
      content: LOGO,
    },
    theme: {
      title: TITLE,
    },
    routePrefix: '/docs',
  }

//==============================================================================
// Logger Configuration
//==============================================================================

/**
 * Environment-specific logger configurations
 * @description Different logger settings based on NODE_ENV
 */
const envToLogger = {
  development: {
    transport: {
      target: 'pino-pretty',
      options: {
        translateTime: 'HH:MM:ss Z',
        ignore: 'pid,hostname',
      },
    },
  },
  production: true,
  test: false,
} as const

//==============================================================================
// Fastify Server Options
//==============================================================================

/**
 * Main Fastify server configuration options
 * @description Sets up the logger based on the current environment
 */
export const fastifyOptions:
  | FastifyHttpOptions<
      Server<typeof IncomingMessage, typeof ServerResponse>,
      FastifyBaseLogger
    >
  | undefined = {
  logger: envToLogger[process.env.NODE_ENV as keyof typeof envToLogger] ?? true,
}
